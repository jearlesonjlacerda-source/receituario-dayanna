<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<title>Receitu√°rio - Dra. Dayanna Mendes (Servidor)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
<style>
  :root{--blue:#2f74c0;--blue-2:#5aa2e6;--text:#1d2833;--muted:#6c7b88;--line:#cbd5e1}
  *{box-sizing:border-box}
  body{margin:0;background:#eef3f7;font-family:Inter,system-ui,Arial,sans-serif;color:var(--text)}
  .wrap{max-width:1100px;margin:18px auto;display:grid;grid-template-columns:360px 1fr;gap:22px;padding:0 12px}

  /* DOCK / HIST√ìRICO */
  .dock{display:flex;gap:8px;margin-bottom:8px}
  .dock .dock-btn{appearance:none;border:0;border-radius:10px;background:#0f172a;color:#fff;font-size:12px;padding:8px 10px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.2)}
  .drawer{background:#fff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.18);overflow:hidden}
  .drawer-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #e5e7eb;background:#f8fafc}
  .drawer-body{padding:10px;display:flex;flex-direction:column;gap:10px}
  .search{display:flex;gap:6px}
  .search input{flex:1;border:1px solid #d1d5db;border-radius:8px;padding:8px;font-size:12px}
  .small-btn{appearance:none;border:1px solid #cbd5e1;border-radius:8px;background:#f1f5f9;color:#0f172a;padding:6px 10px;font-size:12px;cursor:pointer}
  .small-btn.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
  .list{height:480px;overflow:auto;border:1px solid #e2e8f0;border-radius:8px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #e2e8f0;padding:8px;text-align:left}
  tbody td{border-bottom:1px solid #eef2f7;padding:8px}
  tbody tr:hover{background:#f8fbff}
  .row-actions{display:flex;gap:6px}
  .pill{display:inline-block;background:#e0f2fe;color:#075985;padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid #bae6fd}

  /* RECEITU√ÅRIO */
  .sheet{background:#fff;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.12);overflow:hidden}
  .header{position:relative;padding:18px 22px 60px;color:#fff;background:linear-gradient(135deg,var(--blue) 0%,var(--blue-2) 100%)}
  .title{font-family:"Playfair Display",serif;font-weight:700;font-size:20px}
  .qual{opacity:.95;letter-spacing:2px;font-size:11px;margin-top:2px}
  .logo-top{position:absolute;right:16px;top:10px;width:58px;height:58px;background:url('logo_dayanna_transparente.png') center/contain no-repeat;filter:drop-shadow(0 1px 2px rgba(0,0,0,.25))}
  .rxno-wrap{position:absolute;left:22px;bottom:10px;display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.12);padding:6px 8px;border-radius:10px;backdrop-filter:blur(2px)}
  .rxno-wrap .tag{background:#195ea9;color:#eaf2ff;border-radius:999px;padding:4px 8px;font-weight:700;letter-spacing:1px}
  .rxno-wrap button{appearance:none;border:0;border-radius:8px;background:rgba(255,255,255,.2);color:#fff;padding:6px 8px;font-size:12px;cursor:pointer}
  .rxno-wrap button:hover{background:rgba(255,255,255,.28)}
  .rxno{font-weight:800;margin:0 4px}
  .body{position:relative;padding:18px 22px}
  .watermark{position:absolute;left:50%;top:56%;transform:translate(-50%,-50%);width:320px;aspect-ratio:1/1;background:url('logo_dayanna_transparente.png') center/contain no-repeat;opacity:.08;pointer-events:none;filter:grayscale(8%) contrast(92%)}
  .line{display:flex;align-items:flex-end;border-bottom:1px solid var(--line);height:22px;margin-bottom:10px;gap:8px}
  .label{min-width:110px;color:#64748b;font-size:12px}
  .editable{border:0;background:transparent;outline:none;width:100%;font-size:13px;color:var(--text)}
  .rx{color:#2f74c0;font-weight:700;font-size:28px;margin:12px 0 6px 2px}
  .presc{margin-top:6px;border:1px solid var(--line);border-radius:6px;height:210px;padding:10px;resize:vertical;background:transparent;width:100%;font-size:13px;color:var(--text)}
  .sign-row{display:flex;justify-content:flex-end;margin-top:18px}
  .sign-line{border-bottom:1px solid var(--line);width:220px;height:28px}
  .sign-label{font-size:12px;color:#64748b;text-align:center;margin-top:6px}
  .footer{background:#f6f9fc;border-top:1px solid var(--line);padding:12px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
  .info{display:flex;align-items:center;gap:8px;color:#334155;font-size:12px}
  .hosp{background:linear-gradient(135deg,#e4f0ff,#d7eaff);border-radius:8px;padding:8px 12px;color:#295c9a;font-weight:700;letter-spacing:.5px}

  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  @media print{
    @page{size:148mm 210mm;margin:0}
    *{-webkit-print-color-adjust:exact !important;print-color-adjust:exact !important}
    body{background:#fff;margin:0}
    .wrap{display:block;margin:0}
    .drawer,.dock,.rxno-wrap button{display:none !important}
    .sheet{width:148mm;height:210mm;border-radius:0;box-shadow:none}
    .header{padding:18mm 15mm 22mm 18mm}
    .body{padding:12mm 18mm 10mm 18mm}
  }
</style>
</head>
<body>

<div class="wrap">

  <!-- COLUNA ESQUERDA: DOCK + HIST√ìRICO -->
  <div>
    <div class="dock">
      <button class="dock-btn" id="toggleHist">üìú Hist√≥rico</button>
      <button class="dock-btn" id="imprimirTopo">üñ®Ô∏è Imprimir / PDF</button>
    </div>

    <div class="drawer" id="drawer">
      <div class="drawer-header">
        <strong>Hist√≥rico de Receitas</strong>
        <div style="display:flex;gap:6px">
          <button class="small-btn" id="exportJSON">Exportar JSON</button>
          <label class="small-btn" style="cursor:pointer">
            Importar JSON
            <input id="importJSON" type="file" accept="application/json" style="display:none">
          </label>
          <button class="small-btn danger" id="wipeAll">Apagar tudo</button>
        </div>
      </div>
      <div class="drawer-body">
        <div class="search">
          <input id="q" placeholder="Buscar por n¬∫ receita, paciente, data, diagn√≥stico..." />
          <button class="small-btn" id="applyFilter">Buscar</button>
          <button class="small-btn" id="clearFilter">Limpar</button>
        </div>
        <div class="list">
          <table>
            <thead>
              <tr><th>N¬∫</th><th>Paciente</th><th>Data</th><th>Diagn√≥stico</th><th>A√ß√µes</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <span class="pill" id="count">0 itens</span>
          <div style="display:flex;gap:6px">
            <button class="small-btn" id="salvar">üíæ Salvar receita</button>
            <button class="small-btn" id="dupl">‚ûï Duplicar em novo n¬∫</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- COLUNA DIREITA: RECEITU√ÅRIO -->
  <div class="sheet" id="sheet">

    <div class="header">
      <div class="title">Dra. Dayanna Mendes</div>
      <div class="qual">CRM-BA 32056</div>
      <div class="logo-top" aria-label="Logo"></div>

      <div class="rxno-wrap">
        <span class="tag">N¬∫ RECEITA</span>
        <span id="rxno" class="rxno">------</span>
        <button id="finalizar" type="button">Finalizar e numerar</button>
        <button id="imprimir" type="button">Imprimir / PDF</button>
        <button id="baixar" type="button">Baixar PDF</button>
      </div>
    </div>

    <div class="body">
      <div class="watermark"></div>

      <div class="line"><div class="label">Paciente:</div><input class="editable" id="paciente" /></div>
      <div class="line"><div class="label">Endere√ßo:</div><input class="editable" id="endereco" /></div>

      <div style="display:flex;gap:12px">
        <div class="line" style="flex:1"><div class="label">Idade:</div>
          <input class="editable" id="idade" inputmode="numeric" maxlength="3" /></div>
        <div class="line" style="flex:1"><div class="label">Data:</div>
          <input class="editable" id="data" inputmode="numeric" maxlength="10" placeholder="DD/MM/AAAA" /></div>
      </div>

      <div class="line"><div class="label">Diagn√≥stico:</div><input class="editable" id="diag" /></div>

      <div class="rx">RX</div>
      <textarea class="presc" id="presc" placeholder="Prescri√ß√£o / Orienta√ß√µes"></textarea>

      <div class="sign-row">
        <div>
          <div class="sign-line"></div>
          <div class="sign-label">ASSINATURA</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="hosp">HOSPITAL / CL√çNICA</div>
      <div class="info">üìû (71) 99999-0000</div>
      <div class="info">‚úâÔ∏è contato@clinicaday.com</div>
      <div class="info">üìç Salvador-BA</div>
    </div>
  </div>

</div>

<!-- libs p/ baixar PDF -->
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ===== CONFIG ===== */
const BASE_URL = 'https://receituario-backend-xxpr.onrender.com';
const API_KEY  = '123456';
//const BASE_URL = 'http://127.0.0.1:8080';
const H = {'Content-Type':'application/json','x-api-key':API_KEY};
const qs = s => document.querySelector(s);

/* ===== HELPERS ===== */
const zeroPad=(n,s=6)=>String(n).replace(/\D/g,'').padStart(s,'0');

/* ===== ELEMENTOS ===== */
const rxSpan=qs('#rxno');
const btnFinalizar=qs('#finalizar');
const btnImprimir=qs('#imprimir');
const btnBaixar=qs('#baixar');
qs('#imprimirTopo').onclick=()=>window.print();

/* ===== CAMPOS ===== */
const idade=qs('#idade'), dataInput=qs('#data');
idade.onkeydown=e=>{const ok=['Backspace','Delete','ArrowLeft','ArrowRight','Tab'];if(ok.includes(e.key))return;if(!/^\d$/.test(e.key))e.preventDefault()};
idade.oninput=e=>e.target.value=e.target.value.replace(/\D/g,'').slice(0,3);
dataInput.onkeydown=e=>{const ok=['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];if(ok.includes(e.key))return;if(!/^\d$/.test(e.key))e.preventDefault()};
const fmt=d=>{d=d.replace(/\D/g,'').slice(0,8);if(d.length>=5)return d.replace(/(\d{2})(\d{2})(\d{0,4})/,'$1/$2/$3');if(d.length>=3)return d.replace(/(\d{2})(\d{0,2})/,'$1/$2');return d};
dataInput.oninput=e=>e.target.value=fmt(e.target.value);
dataInput.onpaste=e=>{e.preventDefault();const t=(e.clipboardData||window.clipboardData).getData('text')||'';dataInput.value=fmt(t)};

function collectForm(rxNo){
  return {
    rxNo,
    paciente: qs('#paciente').value.trim(),
    endereco: qs('#endereco').value.trim(),
    idade: qs('#idade').value.trim(),
    data: qs('#data').value.trim(),
    diag: qs('#diag').value.trim(),
    presc: qs('#presc').value.trim(),
  };
}

/* ===== API ===== */
async function api(path, opts={}) {
  const r = await fetch(BASE_URL+path,{...opts, headers:{...H, ...(opts.headers||{})}});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

/* ===== PR√âVIA DO N√öMERO ===== */
async function loadPreview(){
  try{
    const {rxNo}=await api('/counter/preview',{headers:{'x-api-key':API_KEY}});
    rxSpan.textContent=rxNo;
  }catch(e){ rxSpan.textContent='ERRO'; console.error(e); }
}
loadPreview();

/* ===== FINALIZAR/Numerar + SALVAR ===== */
btnFinalizar.onclick=async()=>{
  if(btnFinalizar.disabled) return;
  try{
    const {rxNo}=await api('/counter/next',{method:'POST'});
    rxSpan.textContent=rxNo;
    const payload=collectForm(rxNo);
    await api('/prescriptions',{method:'POST',body:JSON.stringify(payload)});
    btnFinalizar.textContent='Numerado ‚úì';
    btnFinalizar.disabled=true;
    alert('Receita '+rxNo+' salva no servidor.');
    renderList(qs('#q').value);
  }catch(e){ alert('Erro ao finalizar: '+e.message); }
};
btnImprimir.onclick=()=>window.print();
btnBaixar.onclick=async()=>{
  const sheet=qs('#sheet');
  const canvas=await html2canvas(sheet,{scale:2,backgroundColor:'#fff'});
  const imgData=canvas.toDataURL('image/jpeg',0.95);
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a5'});
  const w=pdf.internal.pageSize.getWidth(), h=pdf.internal.pageSize.getHeight();
  const imgH=(canvas.height/canvas.width)*w, offY=(h-imgH)/2;
  pdf.addImage(imgData,'JPEG',0,offY,w,imgH);
  pdf.save(`Receituario_${rxSpan.textContent}.pdf`);
};

/* ===== HIST√ìRICO (via servidor) ===== */
const drawer=qs('#drawer');
qs('#toggleHist').onclick=()=>drawer.scrollIntoView({behavior:'smooth'});

const elTbody=qs('#tbody'), elQ=qs('#q'), elCount=qs('#count');
qs('#applyFilter').onclick=()=>renderList(elQ.value);
qs('#clearFilter').onclick=()=>{elQ.value=''; renderList('')};

function rowTemplate(r){
  const diag=r.diag||'', pac=r.paciente||'';
  return `<tr>
    <td><strong>${r.rxNo}</strong></td>
    <td>${pac}</td>
    <td>${r.data||''}</td>
    <td title="${diag}">${diag.length>28?diag.slice(0,28)+'‚Ä¶':diag}</td>
    <td class="row-actions">
      <button class="small-btn" data-act="open" data-id="${r.id}">Abrir</button>
      <button class="small-btn" data-act="dup" data-id="${r.id}">Duplicar</button>
      <button class="small-btn danger" data-act="del" data-id="${r.id}">Excluir</button>
    </td>
  </tr>`;
}

async function renderList(q=''){
  try{
    const list=await api('/prescriptions'+(q?`?q=${encodeURIComponent(q)}`:''),{headers:{'x-api-key':API_KEY}});
    elTbody.innerHTML=list.map(rowTemplate).join('') || `<tr><td colspan="5" style="padding:14px;color:#64748b">Sem itens</td></tr>`;
    elCount.textContent=`${list.length} item${list.length===1?'':'s'}`;
  }catch(e){ console.error(e); }
}
renderList();

/* a√ß√µes do hist√≥rico */
elTbody.onclick=async(e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=parseInt(btn.dataset.id,10), act=btn.dataset.act;
  // busca o item selecionado
  const list=await api('/prescriptions',{headers:{'x-api-key':API_KEY}});
  const item=list.find(x=>x.id===id); if(!item) return;

  if(act==='open'){
    qs('#paciente').value=item.paciente||'';
    qs('#endereco').value=item.endereco||'';
    qs('#idade').value=item.idade||'';
    qs('#data').value=item.data||'';
    qs('#diag').value=item.diag||'';
    qs('#presc').value=item.presc||'';
    window.scrollTo({top:0,behavior:'smooth'});
  }else if(act==='dup'){
    // carrega dados e pede novo n√∫mero
    qs('#paciente').value=item.paciente||'';
    qs('#endereco').value=item.endereco||'';
    qs('#idade').value=item.idade||'';
    qs('#data').value=item.data||'';
    qs('#diag').value=item.diag||'';
    qs('#presc').value=item.presc||'';
    const {rxNo}=await api('/counter/preview');
    rxSpan.textContent=rxNo;
    btnFinalizar.disabled=false; btnFinalizar.textContent='Finalizar e numerar';
  }else if(act==='del'){
    if(!confirm('Excluir a receita '+item.rxNo+'?')) return;
    await api('/prescriptions/'+id,{method:'DELETE'});
    renderList(elQ.value);
  }
};

/* salvar manual (sob o mesmo n¬∫ mostrado) */
qs('#salvar').onclick=async()=>{
  try{
    const rxNo=rxSpan.textContent.replace(/\D/g,'');
    if(!rxNo){ alert('Gere um n√∫mero primeiro (Finalizar e numerar).'); return; }
    await api('/prescriptions',{method:'POST',body:JSON.stringify(collectForm(rxNo))});
    alert('Receita salva.');
    renderList(elQ.value);
  }catch(e){ alert('Erro ao salvar: '+e.message); }
};

/* duplicar em novo n¬∫ (somente preparar) */
qs('#dupl').onclick=async()=>{
  const {rxNo}=await api('/counter/preview');
  rxSpan.textContent=rxNo;
  btnFinalizar.disabled=false; btnFinalizar.textContent='Finalizar e numerar';
};

/* exportar/importar JSON */
qs('#exportJSON').onclick=async()=>{
  const list=await api('/prescriptions');
  const blob=new Blob([JSON.stringify(list,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`historico_receitas_${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(a.href);
};
qs('#importJSON').onchange=async()=>{
  const f=qs('#importJSON').files[0]; if(!f) return;
  const txt=await f.text(); let arr;
  try{ arr=JSON.parse(txt); if(!Array.isArray(arr)) throw 0; }catch{ alert('JSON inv√°lido'); return; }
  for(const r of arr){
    const {id, createdAt, updatedAt, ...rest}=r;
    // importa preservando rxNo; se rxNo n√£o existir, servidor consome um novo
    try{ await api('/prescriptions',{method:'POST',body:JSON.stringify(rest)});}catch(e){console.warn('Falha ao importar item',e);}
  }
  renderList(); alert('Importa√ß√£o conclu√≠da.');
};
/* apagar tudo (servidor) ‚Äî simples: apaga um por um */
qs('#wipeAll').onclick=async()=>{
  if(!confirm('Apagar TODO o hist√≥rico do servidor?')) return;
  const list=await api('/prescriptions'); for(const r of list){ await api('/prescriptions/'+r.id,{method:'DELETE'}); }
  renderList();
};
</script>
</body>
</html>



